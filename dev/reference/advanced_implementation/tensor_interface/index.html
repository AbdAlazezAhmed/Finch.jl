<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tensor Interface · Finch.jl</title><meta name="title" content="Tensor Interface · Finch.jl"/><meta property="og:title" content="Tensor Interface · Finch.jl"/><meta property="twitter:title" content="Tensor Interface · Finch.jl"/><meta name="description" content="Documentation for Finch.jl."/><meta property="og:description" content="Documentation for Finch.jl."/><meta property="twitter:description" content="Documentation for Finch.jl."/><meta property="og:url" content="https://willow-ahrens.github.io/Finch.jl/reference/advanced_implementation/tensor_interface/"/><meta property="twitter:url" content="https://willow-ahrens.github.io/Finch.jl/reference/advanced_implementation/tensor_interface/"/><link rel="canonical" href="https://willow-ahrens.github.io/Finch.jl/reference/advanced_implementation/tensor_interface/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.png" alt="Finch.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Finch.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Comprehensive Guides</span><ul><li><a class="tocitem" href="../../../guides/calling_finch/">Calling Finch</a></li><li><a class="tocitem" href="../../../guides/tensor_formats/">Tensor Formats</a></li><li><a class="tocitem" href="../../../guides/sparse_utils/">Sparse and Structured Utilities</a></li><li><a class="tocitem" href="../../../guides/finch_language/">The Finch Language</a></li><li><a class="tocitem" href="../../../guides/dimensionalization/">Dimensionalization</a></li><li><a class="tocitem" href="../../../guides/index_sugar/">Index Sugar</a></li><li><a class="tocitem" href="../../../guides/mask_sugar/">Mask Sugar</a></li><li><a class="tocitem" href="../../../guides/iteration_protocols/">Iteration Protocols</a></li><li><a class="tocitem" href="../../../guides/custom_operators/">Custom Operators</a></li><li><a class="tocitem" href="../../../guides/array_api/">High-Level Array API</a></li><li><a class="tocitem" href="../../../guides/fileio/">FileIO</a></li><li><a class="tocitem" href="../../../guides/interoperability/">Interoperability</a></li><li><a class="tocitem" href="../../../guides/optimization_tips/">Optimization Tips</a></li><li><a class="tocitem" href="../../../guides/benchmarking_tips/">Benchmarking Tips</a></li></ul></li><li><span class="tocitem">Technical Reference</span><ul><li><a class="tocitem" href="../../listing/">Documentation Listing</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox" checked/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Advanced Implementation Details</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../internals/">Internals</a></li><li class="is-active"><a class="tocitem" href>Tensor Interface</a><ul class="internal"><li><a class="tocitem" href="#Types-and-Storage-of-Level"><span>Types and Storage of Level</span></a></li></ul></li></ul></li></ul></li><li><a class="tocitem" href="../../../CONTRIBUTING/">Community and Contributions</a></li><li><span class="tocitem">Appendices and Additional Resources</span><ul><li><a class="tocitem" href="../../../appendices/directory_structure/">Directory Structure</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Technical Reference</a></li><li><a class="is-disabled">Advanced Implementation Details</a></li><li class="is-active"><a href>Tensor Interface</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tensor Interface</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/willow-ahrens/Finch.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/willow-ahrens/Finch.jl/blob/main/docs/src/reference/advanced_implementation/tensor_interface.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Advanced-Tensor-Storage-Formats"><a class="docs-heading-anchor" href="#Advanced-Tensor-Storage-Formats">Advanced Tensor Storage Formats</a><a id="Advanced-Tensor-Storage-Formats-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Tensor-Storage-Formats" title="Permalink"></a></h1><pre><code class="language-julia-repl hljs">julia&gt; A = [0.0 0.0 4.4; 1.1 0.0 0.0; 2.2 0.0 5.5; 3.3 0.0 0.0]
4×3 Matrix{Float64}:
 0.0  0.0  4.4
 1.1  0.0  0.0
 2.2  0.0  5.5
 3.3  0.0  0.0
julia&gt; A_fbr = Tensor(Dense(Dense(Element(0.0))), A)
Dense [:,1:3]
├─ [:, 1]: Dense [1:4]
│  ├─ [1]: 0.0
│  ├─ [2]: 1.1
│  ├─ [3]: 2.2
│  └─ [4]: 3.3
├─ [:, 2]: Dense [1:4]
│  ├─ [1]: 0.0
│  ├─ [2]: 0.0
│  ├─ [3]: 0.0
│  └─ [4]: 0.0
└─ [:, 3]: Dense [1:4]
   ├─ [1]: 4.4
   ├─ [2]: 0.0
   ├─ [3]: 5.5
   └─ [4]: 0.0</code></pre><p>We refer to a node in the tree as a subfiber. All of the nodes at the same level are stored in the same datastructure, and disambiguated by an integer <code>position</code>.  in the above example, there are three levels: the rootmost level contains only one subfiber, the root. The middle level has 3 subfibers, one for each column. The leafmost level has 12 subfibers, one for each element of the array.  For example, the first level is <code>A_fbr.lvl</code>, and we can represent it&#39;s third position as <code>SubFiber(A_fbr.lvl.lvl, 3)</code>. The second level is <code>A_fbr.lvl.lvl</code>, and we can access it&#39;s 9th position as <code>SubFiber(A_fbr.lvl.lvl.lvl, 9)</code>. For instructional purposes, you can use parentheses to call a subfiber on an index to select among children of a subfiber.</p><pre><code class="language-julia-repl hljs">julia&gt; Finch.SubFiber(A_fbr.lvl.lvl, 3)
Dense [1:4]
├─ [1]: 4.4
├─ [2]: 0.0
├─ [3]: 5.5
└─ [4]: 0.0

julia&gt; A_fbr[:, 3]
Dense [1:4]
├─ [1]: 4.4
├─ [2]: 0.0
├─ [3]: 5.5
└─ [4]: 0.0

julia&gt; A_fbr(3)
Dense [1:4]
├─ [1]: 4.4
├─ [2]: 0.0
├─ [3]: 5.5
└─ [4]: 0.0

julia&gt; Finch.SubFiber(A_fbr.lvl.lvl.lvl, 9)
4.4

julia&gt; A_fbr[1, 3]
4.4

julia&gt; A_fbr(3)(1)
4.4
</code></pre><p>When we print the tree in text, positions are numbered from top to bottom. However, if we visualize our tree with the root at the top, positions range from left to right:</p><p><img src="../../../assets/levels-A-d-d-e.png" alt="Dense Format Index Tree"/></p><p>Because our array is sparse, (mostly zero, or another fill value), it would be more efficient to store only the nonzero values. In Finch, each level is represented with a different format. A sparse level only stores non-fill values. This time, we&#39;ll use a tensor constructor with <code>sl</code> (for &quot;<code>SparseList</code> of nonzeros&quot;) instead of <code>d</code> (for &quot;<code>Dense</code>&quot;):</p><pre><code class="language-julia-repl hljs">julia&gt; A_fbr = Tensor(Dense(SparseList(Element(0.0))), A)
Dense [:,1:3]
├─ [:, 1]: SparseList (0.0) [1:4]
│  ├─ [2]: 1.1
│  ├─ [3]: 2.2
│  └─ [4]: 3.3
├─ [:, 2]: SparseList (0.0) [1:4]
└─ [:, 3]: SparseList (0.0) [1:4]
   ├─ [1]: 4.4
   └─ [3]: 5.5</code></pre><p><img src="../../../assets/levels-A-d-sl-e.png" alt="CSC Format Index Tree"/></p><p>Our <code>Dense(SparseList(Element(0.0)))</code> format is also known as <a href="https://en.wikipedia.org/wiki/Sparse_matrix#Compressed_sparse_column_.28CSC_or_CCS.29">&quot;CSC&quot;</a> and is equivalent to <a href="https://sparsearrays.juliasparse.org/dev/#man-csc"><code>SparseMatrixCSC</code></a>. The <a href="../../../guides/tensor_formats/#Finch.Tensor"><code>Tensor</code></a> function will perform a zero-cost copy between Finch fibers and sparse matrices, when available.  CSC is an excellent general-purpose representation when we expect most of the columns to have a few nonzeros. However, when most of the columns are entirely fill (a situation known as hypersparsity), it is better to compress the root level as well:</p><pre><code class="language-julia-repl hljs">julia&gt; A_fbr = Tensor(SparseList(SparseList(Element(0.0))), A)
SparseList (0.0) [:,1:3]
├─ [:, 1]: SparseList (0.0) [1:4]
│  ├─ [2]: 1.1
│  ├─ [3]: 2.2
│  └─ [4]: 3.3
└─ [:, 3]: SparseList (0.0) [1:4]
   ├─ [1]: 4.4
   └─ [3]: 5.5</code></pre><p><img src="../../../assets/levels-A-sl-sl-e.png" alt="DCSC Format Index Tree"/></p><p>Here we see that the entirely zero column has also been compressed. The <code>SparseList(SparseList(Element(0.0)))</code> format is also known as <a href="https://ieeexplore.ieee.org/document/4536313">&quot;DCSC&quot;</a>.</p><p>The <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.coo_matrix.html">&quot;COO&quot;</a> (or &quot;Coordinate&quot;) format is often used in practice for ease of interchange between libraries. In an <code>N</code>-dimensional array <code>A</code>, COO stores <code>N</code> lists of indices <code>I_1, ..., I_N</code> where <code>A[I_1[p], ..., I_N[p]]</code> is the <code>p</code>^th stored value in column-major numbering. In Finch, <code>COO</code> is represented as a multi-index level, which can handle more than one index at once. We use curly brackets to declare the number of indices handled by the level:</p><pre><code class="language-julia-repl hljs">julia&gt; A_fbr = Tensor(SparseCOO{2}(Element(0.0)), A)
SparseCOO{2} (0.0) [:,1:3]
├─ [2, 1]: 1.1
├─ [3, 1]: 2.2
├─ [4, 1]: 3.3
├─ [1, 3]: 4.4
└─ [3, 3]: 5.5</code></pre><p><img src="../../../assets/levels-A-sc2-e.png" alt="COO Format Index Tree"/></p><p>The COO format is compact and straightforward, but doesn&#39;t support random access. For random access, one should use the <code>SparseHash</code> format. A full listing of supported formats is described after a rough description of shared common internals of level, relating to types and storage.</p><h2 id="Types-and-Storage-of-Level"><a class="docs-heading-anchor" href="#Types-and-Storage-of-Level">Types and Storage of Level</a><a id="Types-and-Storage-of-Level-1"></a><a class="docs-heading-anchor-permalink" href="#Types-and-Storage-of-Level" title="Permalink"></a></h2><p>All levels have a <code>postype</code>, typically denoted as <code>Tp</code> in the constructors, used for internal pointer types but accessible by the function:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Finch.postype" href="#Finch.postype"><code>Finch.postype</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">postype(lvl)</code></pre><p>Return a position type with the same flavor as those used to store the positions of the fibers contained in <code>lvl</code>. The name position descends from the pos or position or pointer arrays found in many definitions of CSR or CSC. In Finch, positions should be data used to access either a subfiber or some other similar auxiliary data. Thus, we often end up iterating over positions.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/willow-ahrens/Finch.jl/blob/c1fab789cfcb6078e2b0f7c92e85d7f8c5222554/src/tensors/abstract_level.jl#L109-L115">source</a></section></article><p>Additionally, many levels have a <code>Vp</code> or <code>Vi</code> in their constructors; these stand for vector of element type <code>Tp</code> or <code>Ti</code>.  More generally, levels are paramterized by the types that they use for storage. By default, all levels use <code>Vector</code>, but a user  could could change any or all of the storage types of a tensor so that the tensor would be stored on a GPU or CPU or some combination thereof,  or even just via a vector with a different allocation mechanism.  The storage type should behave like <code>AbstractArray</code>  and needs to implement the usual abstract array functions and <code>Base.resize!</code>. See the tests for an example. </p><p>When levels are constructed in short form as in the examples above, the index, position, and storage types are inferred from the level below. All the levels at the bottom of a Tensor (<code>Element, Pattern, Repeater</code>) specify an index type, position type, and storage type even if they don&#39;t need them. These are used by levels that take these as parameters. </p><h3 id="Move-to:-Copying-Fibers-to-a-new-storage-type."><a class="docs-heading-anchor" href="#Move-to:-Copying-Fibers-to-a-new-storage-type.">Move to: Copying Fibers to a new storage type.</a><a id="Move-to:-Copying-Fibers-to-a-new-storage-type.-1"></a><a class="docs-heading-anchor-permalink" href="#Move-to:-Copying-Fibers-to-a-new-storage-type." title="Permalink"></a></h3><p>If one needs to copy a tensor to another tensor with a different storage type, one can use the <code>moveto</code> function, described below.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Finch.moveto" href="#Finch.moveto"><code>Finch.moveto</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">moveto(arr, device)</code></pre><p>If the array is not on the given device, it creates a new version of this array on that device and copies the data in to it, according to the <code>device</code> trait.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/willow-ahrens/Finch.jl/blob/c1fab789cfcb6078e2b0f7c92e85d7f8c5222554/src/abstract_tensor.jl#L99-L104">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../internals/">« Internals</a><a class="docs-footer-nextpage" href="../../../CONTRIBUTING/">Community and Contributions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Monday 13 May 2024 13:56">Monday 13 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
