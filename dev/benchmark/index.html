<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Benchmarking · Finch.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://willow-ahrens.github.io/Finch.jl/benchmark/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="Finch.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">Finch.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../usage/">Usage</a></li><li><a class="tocitem" href="../semantics/">Semantics</a></li><li><a class="tocitem" href="../fibers/">Array Formats</a></li><li><a class="tocitem" href="../algebra/">Custom Functions</a></li><li><a class="tocitem" href="../fileio/">Tensor File I/O</a></li><li><a class="tocitem" href="../interop/">C, C++, ...</a></li><li><a class="tocitem" href="../performance/">Performance Tips</a></li><li><a class="tocitem" href="../internals/">Internals</a></li><li><a class="tocitem" href="../directory_structure/">Directory Structure</a></li><li><a class="tocitem" href="../CONTRIBUTING/">Contributing</a></li><li><span class="tocitem">Tutorials</span><ul><li class="is-active"><a class="tocitem" href>Benchmarking</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Benchmarking</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Benchmarking</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/willow-ahrens/Finch.jl/blob/main/docs/src/benchmark.jl#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Benchmarking"><a class="docs-heading-anchor" href="#Benchmarking">Benchmarking</a><a id="Benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking" title="Permalink"></a></h1><p>Julia code is <a href="https://github.com/JuliaCI/BenchmarkTools.jl#why-does-this-package-exist">nototoriously fussy</a> to benchmark. We&#39;ll use <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> to automatically follow best practices for getting reliable julia benchmarks. We&#39;ll also follow the <a href="https://docs.julialang.org/en/v1/manual/performance-tips/">Julia Performance Tips</a>.</p><p>Finch is even trickier to benchmark, for a few reasons:</p><ol><li>The first time an @finch function is called, it is compiled, which takes an extra long time. @finch can also incur dynamic dispatch costs if the array types are not <a href="https://docs.julialang.org/en/v1/manual/faq/#man-type-stability">type stable</a>. We can remedy this by using <a href="../usage/#Finch.@finch_kernel"><code>@finch_kernel</code></a>, which simplifies benchmarking by compiling the function ahead of time, so it behaves like a normal Julia function. If you must use <code>@finch</code>, try to ensure that the code is type-stable.</li><li>Finch fibers reuse memory from previous calls, so the first time a fiber is used in a finch function, it will allocate memory, but subsequent times not so much. If we want to benchmark the memory allocation, we can reconstruct the fiber each time. Otherwise, we can let the repeated executions of the kernel measure the non-allocating runtime.</li><li>Runtime for sparse code often depends on the sparsity pattern, so it&#39;s important to benchmark with representative data. Using standard matrices or tensors from <a href="https://github.com/JuliaLinearAlgebra/MatrixDepot.jl">MatrixDepot.jl</a> or <a href="https://github.com/willow-ahrens/TensorDepot.jl">TensorDepot.jl</a> is a good way to do this.</li></ol><pre><code class="language-julia hljs">using Finch
using BenchmarkTools
using SparseArrays
using MatrixDepot</code></pre><pre><code class="nohighlight hljs">[ Info: verify download of index files...
[ Info: creating database file
[ Info: reading index files
[ Info: downloading: https://sparse.tamu.edu/files/ss_index.mat
[ Info: downloading index file https://math.nist.gov/MatrixMarket/matrices.html
[ Info: adding metadata...
[ Info: adding svd data...
[ Info: writing database
[ Info: used remote sites are sparse.tamu.edu with MAT index and math.nist.gov with HTML index
</code></pre><p>Load a sparse matrix from MatrixDepot.jl and convert it to a Finch fiber</p><pre><code class="language-julia hljs">A = Fiber!(Dense(SparseList(Element(0.0))), matrixdepot(&quot;HB/west0067&quot;))
(m, n) = size(A)

x = Fiber!(Dense(Element(0.0)), rand(n))
y = Fiber!(Dense(Element(0.0)))</code></pre><pre><code class="nohighlight hljs">Dense [1:0]</code></pre><p>Construct a Finch kernel for sparse matrix-vector multiply</p><pre><code class="language-julia hljs">eval(@finch_kernel function spmv(y, A, x)
    y .= 0
    for j = _, i = _
        y[i] += A[i, j] * x[j]
    end
end)</code></pre><pre><code class="nohighlight hljs">spmv (generic function with 1 method)</code></pre><p>Benchmark the kernel, ignoring allocation costs for y</p><pre><code class="language-julia hljs">@benchmark spmv($y, $A, $x)</code></pre><pre><code class="nohighlight hljs">BenchmarkTools.Trial: 10000 samples with 142 evaluations.
 Range (min … max):  709.866 ns …  1.187 μs  ┊ GC (min … max): 0.00% … 0.00%
 Time  (median):     722.542 ns              ┊ GC (median):    0.00%
 Time  (mean ± σ):   724.007 ns ± 11.449 ns  ┊ GC (mean ± σ):  0.00% ± 0.00%

             █▃▁▂                                               
  ▂▂▂▂▂▂▂▄▃█▇████▄▄▃▃▃▃▃▂▂▂▂▂▂▂▂▂▂▁▁▂▁▂▁▂▁▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂ ▃
  710 ns          Histogram: frequency by time          770 ns &lt;

 Memory estimate: 0 bytes, allocs estimate: 0.</code></pre><p>The <code>@benchmark</code> macro will benchmark a function in local scope, and it will run the function a few times to estimate the runtime. It will also try to avoid first-time compilation costs by running the function once before benchmarking it. Note the use of <code>$</code> to interpolate the arrays into the benchmark, bringing them into the local scope.</p><p>We can also benchmark the memory allocation of the kernel by constructing <code>y</code> in the benchmark kernel</p><pre><code class="language-julia hljs">@benchmark begin
    y = Fiber!(Dense(Element(0.0)))
    y = spmv(y, $A, $x).y
end</code></pre><pre><code class="nohighlight hljs">BenchmarkTools.Trial: 10000 samples with 158 evaluations.
 Range (min … max):  663.937 ns … 166.401 μs  ┊ GC (min … max):  0.00% … 99.41%
 Time  (median):     967.734 ns               ┊ GC (median):     0.00%
 Time  (mean ± σ):   995.964 ns ±   4.885 μs  ┊ GC (mean ± σ):  14.70% ±  2.98%

   █                                               ▁             
  ▆█▇▄▆▃▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▁▁▂▁▂▂▂▁▁▁▂▁▁▁▁▁▁▁▁▁▂▃▄▆███▆▅▄▃▃▃▃▂▂▂ ▃
  664 ns           Histogram: frequency by time         1.06 μs &lt;

 Memory estimate: 624 bytes, allocs estimate: 2.</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../CONTRIBUTING/">« Contributing</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 11 September 2023 20:19">Monday 11 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
